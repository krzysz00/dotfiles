# use ruby [version] [gemset]
use_ruby() {
  local ver=$1
  if [[ -z $ver ]] && [[ -f .ruby-version ]]; then
    ver=$(cat .ruby-version)
  fi
  if [[ -z $ver ]]; then
    log_error Unknown ruby version
    exit 1
  fi
  local rubies_path=$HOME/.rbenv/versions
  if ! [[ -d $rubies_path/$ver ]]; then
     loc_error Ruby version $ver not installed
     exit 1
  fi
  load_prefix $rubies_path/$ver

  local gemsets_path=$HOME/.cache/gemsets
  local gemset=$2
  if [[ -z $gemset ]] && [[ -f .ruby-gemset ]]; then
    gemset=$(cat .ruby-gemset)
  fi
  if [[ -d $gemsets_path ]] && [[ -n $gemset ]]; then
     direnv_layout_dir=$gemsets_path/ruby-$ver-$gemset
  fi
  layout ruby
}

# Usage: use iree iree_project_root iree_build_dir [python path] [iree_src_dir]
# iree_source_dir defaults to the project root or [project root]/src, depending
# on where tools/utils is found.
use_iree() {
  if [[ $# -lt 2 || $# -gt 4 ]]; then
     log_error "Usage: use iree iree_project_root iree_build_dir [python path] [iree_source_dir]"
  fi
  local project_root="$1"
  local build_dir="$2"
  local python_ver="${3:-python3}"
  local source_dir_default="$1"
  # TODO: update this to detect tools/utils once it exists
  if [[ ! -d "${source_dir_default}/compiler" && -d "${source_dir_default}/src/compiler" ]]; then
      source_dir_default="${source_dir_default}/src"
  fi
  local source_dir="${4:-${source_dir_default}}"
  PATH_add "${source_dir}/tools/utils/bin"

  local REPLY
  realpath.absolute "$project_root"
  direnv_layout_dir="$REPLY/.direnv"
  local venv_path="$(direnv_layout_dir)/python-uv"
  if [[ ! -d $(direnv_layout_dir)/uv-venv ]]; then
      uv venv --python "${python_ver} ${venv_path}"
  fi
  export VIRTUAL_ENV="${venv_path}"
  PATH_add "${venv_path}/bin"

  realpath.absolute "$build_dir"
  local abs_build_dir="$REPLY"
  PATH_add "$abs_build_dir/tools"
  export IREE_BUILD_DIRECTORY="$REPLY"
  path_add PYTHONPATH "$abs_build_dir/runtime/binidngs/python"
  path_add PYTHONPATH "$abs_build_dir/compiler/bindings/python"
}
